openapi: 3.0.3
info:
  title: To-Do Platform API
  version: "1.0.0"
  description: |
    REST API для фронтенда. Разбит по сервисам, но документы собраны в одном OpenAPI.
servers:
  - url: http://localhost:8081
    description: User-service (auth/profile/admin)
  - url: http://localhost:8082
    description: Task-service (tasks/categories/comments)
  - url: http://localhost:8083
    description: Analytics-service (metrics)
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    ErrorResponse:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
    AuthTokens:
      type: object
      properties:
        accessToken:
          type: string
        accessTokenExpiresAt:
          type: string
          format: date-time
        refreshToken:
          type: string
        refreshTokenExpiresAt:
          type: string
          format: date-time
    User:
      type: object
      properties:
        id:
          type: integer
          format: int64
        email:
          type: string
        name:
          type: string
        role:
          type: string
        isActive:
          type: boolean
    UserPreferences:
      type: object
      properties:
        notificationsEnabled:
          type: boolean
        emailNotifications:
          type: boolean
        theme:
          type: string
        language:
          type: string
        timezone:
          type: string
    Task:
      type: object
      properties:
        id:
          type: integer
          format: int64
        userId:
          type: integer
          format: int64
        title:
          type: string
        description:
          type: string
        status:
          type: string
          enum: [pending, in_progress, completed, archived]
        priority:
          type: string
          enum: [low, medium, high]
        dueDate:
          type: string
          format: date-time
          nullable: true
        categoryId:
          type: integer
          format: int64
          nullable: true
        category:
          $ref: "#/components/schemas/CategoryShort"
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    CategoryShort:
      type: object
      properties:
        id:
          type: integer
          format: int64
        name:
          type: string
    Comment:
      type: object
      properties:
        id:
          type: integer
          format: int64
        taskId:
          type: integer
          format: int64
        userId:
          type: integer
          format: int64
        content:
          type: string
        createdAt:
          type: string
          format: date-time
    DailyMetrics:
      type: object
      properties:
        userId:
          type: integer
          format: int64
        date:
          type: string
          format: date
        createdTasks:
          type: integer
        completedTasks:
          type: integer
        totalTasks:
          type: integer
        updatedAt:
          type: string
          format: date-time
  responses:
    BadRequest:
      description: Неверный запрос
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
    Unauthorized:
      description: Требуется авторизация
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
    Forbidden:
      description: Недостаточно прав
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
    NotFound:
      description: Не найдено
      content:
        application/json:
          schema: { $ref: "#/components/schemas/ErrorResponse" }
paths:
  /auth/register:
    post:
      summary: Регистрация пользователя
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, name, password]
              properties:
                email: { type: string, format: email }
                name: { type: string }
                password: { type: string, format: password }
      responses:
        "201":
          description: Успешная регистрация
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: "#/components/schemas/User"
                  tokens:
                    $ref: "#/components/schemas/AuthTokens"
        "400": { $ref: "#/components/responses/BadRequest" }
  /auth/login:
    post:
      summary: Логин
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, format: email }
                password: { type: string, format: password }
      responses:
        "200":
          description: Успешный вход
          content:
            application/json:
              schema:
                type: object
                properties:
                  user:
                    $ref: "#/components/schemas/User"
                  tokens:
                    $ref: "#/components/schemas/AuthTokens"
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
  /auth/refresh:
    post:
      summary: Обновление токенов
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refreshToken]
              properties:
                refreshToken: { type: string }
      responses:
        "200":
          description: Новые токены
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/AuthTokens"
        "401": { $ref: "#/components/responses/Unauthorized" }
  /auth/logout:
    post:
      summary: Выход и отзыв refresh-токена
      tags: [auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [refreshToken]
              properties:
                refreshToken: { type: string }
      responses:
        "204":
          description: Успешно
  /auth/validate:
    post:
      summary: Валидация access-токена
      tags: [auth]
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: Данные пользователя
          content:
            application/json:
              schema:
                type: object
                properties:
                  userId: { type: integer, format: int64 }
                  email: { type: string }
                  role: { type: string }
                  expiresAt: { type: string, format: date-time }
        "401": { $ref: "#/components/responses/Unauthorized" }
  /users/profile:
    get:
      summary: Профиль текущего пользователя
      tags: [profile]
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: Профиль
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401": { $ref: "#/components/responses/Unauthorized" }
    put:
      summary: Обновление профиля
      tags: [profile]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                avatarUrl: { type: string }
      responses:
        "200":
          description: Обновлённый профиль
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/User"
        "401": { $ref: "#/components/responses/Unauthorized" }
  /users/preferences:
    get:
      summary: Получить предпочтения
      tags: [profile]
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: Предпочтения
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserPreferences"
        "401": { $ref: "#/components/responses/Unauthorized" }
    put:
      summary: Обновить предпочтения
      tags: [profile]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/UserPreferences"
      responses:
        "200":
          description: Обновлённые предпочтения
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/UserPreferences"
        "401": { $ref: "#/components/responses/Unauthorized" }
  /admin/users:
    get:
      summary: Список пользователей
      tags: [admin]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: limit
          schema: { type: integer, default: 20 }
        - in: query
          name: offset
          schema: { type: integer, default: 0 }
      responses:
        "200":
          description: Список
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/User" }
        "403": { $ref: "#/components/responses/Forbidden" }
  /admin/users/{id}/role:
    put:
      summary: Обновить роль пользователя
      tags: [admin]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [role]
              properties:
                role: { type: string, example: admin }
      responses:
        "200":
          description: Обновлённый пользователь
          content:
            application/json:
              schema: { $ref: "#/components/schemas/User" }
        "403": { $ref: "#/components/responses/Forbidden" }
  /admin/users/{id}/status:
    put:
      summary: Изменить статус пользователя
      tags: [admin]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [isActive]
              properties:
                isActive: { type: boolean }
      responses:
        "200":
          description: Обновлённый пользователь
          content:
            application/json:
              schema: { $ref: "#/components/schemas/User" }
        "403": { $ref: "#/components/responses/Forbidden" }
  /tasks:
    get:
      summary: Список задач текущего пользователя
      tags: [tasks]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: query
          name: status
          schema: { type: string }
        - in: query
          name: priority
          schema: { type: string }
        - in: query
          name: categoryId
          schema: { type: integer, format: int64 }
        - in: query
          name: search
          schema: { type: string }
        - in: query
          name: dueFrom
          schema: { type: string, format: date-time }
        - in: query
          name: dueTo
          schema: { type: string, format: date-time }
        - in: query
          name: limit
          schema: { type: integer, default: 20 }
        - in: query
          name: offset
          schema: { type: integer, default: 0 }
      responses:
        "200":
          description: Массив задач
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Task" }
        "401": { $ref: "#/components/responses/Unauthorized" }
    post:
      summary: Создать задачу
      tags: [tasks]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [title]
              properties:
                title: { type: string }
                description: { type: string }
                status:
                  {
                    type: string,
                    enum: [pending, in_progress, completed, archived],
                  }
                priority: { type: string, enum: [low, medium, high] }
                dueDate: { type: string, format: date-time }
                categoryId: { type: integer, format: int64 }
      responses:
        "201":
          description: Созданная задача
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Task" }
        "400": { $ref: "#/components/responses/BadRequest" }
        "401": { $ref: "#/components/responses/Unauthorized" }
  /tasks/{id}:
    get:
      summary: Получить задачу
      tags: [tasks]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64 }
      responses:
        "200":
          description: Задача
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Task" }
        "404": { $ref: "#/components/responses/NotFound" }
    put:
      summary: Обновить задачу
      tags: [tasks]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title: { type: string }
                description: { type: string }
                status:
                  {
                    type: string,
                    enum: [pending, in_progress, completed, archived],
                  }
                priority: { type: string, enum: [low, medium, high] }
                dueDate: { type: string, format: date-time, nullable: true }
                clearDueDate: { type: boolean }
                categoryId: { type: integer, format: int64, nullable: true }
                clearCategory: { type: boolean }
      responses:
        "200":
          description: Обновлённая задача
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Task" }
        "404": { $ref: "#/components/responses/NotFound" }
    delete:
      summary: Архивировать/удалить задачу
      tags: [tasks]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64 }
      responses:
        "204":
          description: Удалено
        "404": { $ref: "#/components/responses/NotFound" }
  /tasks/{id}/status:
    patch:
      summary: Обновить статус задачи
      tags: [tasks]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [status]
              properties:
                status:
                  {
                    type: string,
                    enum: [pending, in_progress, completed, archived],
                  }
      responses:
        "200":
          description: Обновлённая задача
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Task" }
  /tasks/{id}/comments:
    get:
      summary: Комментарии к задаче
      tags: [comments]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64 }
      responses:
        "200":
          description: Список комментариев
          content:
            application/json:
              schema:
                type: array
                items: { $ref: "#/components/schemas/Comment" }
    post:
      summary: Добавить комментарий
      tags: [comments]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64 }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content: { type: string }
      responses:
        "201":
          description: Созданный комментарий
          content:
            application/json:
              schema: { $ref: "#/components/schemas/Comment" }
  /categories:
    get:
      summary: Список категорий пользователя
      tags: [categories]
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: Категории
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id: { type: integer, format: int64 }
                    userId: { type: integer, format: int64 }
                    name: { type: string }
                    createdAt: { type: string, format: date-time }
    post:
      summary: Создать категорию
      tags: [categories]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name]
              properties:
                name: { type: string }
      responses:
        "201":
          description: Созданная категория
          content:
            application/json:
              schema:
                type: object
                properties:
                  id: { type: integer, format: int64 }
                  userId: { type: integer, format: int64 }
                  name: { type: string }
                  createdAt: { type: string, format: date-time }
  /categories/{id}:
    delete:
      summary: Удалить категорию
      tags: [categories]
      security: [{ bearerAuth: [] }]
      parameters:
        - in: path
          name: id
          required: true
          schema: { type: integer, format: int64 }
      responses:
        "204":
          description: Удалено
  /export/csv:
    get:
      summary: Экспорт задач в CSV
      tags: [export]
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: CSV файл с задачами
          content:
            text/csv:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
                example: attachment; filename="tasks_2024-12-10.csv"
        "401": { $ref: "#/components/responses/Unauthorized" }
  /export/ical:
    get:
      summary: Экспорт задач в iCalendar
      tags: [export]
      security: [{ bearerAuth: [] }]
      responses:
        "200":
          description: iCalendar файл с задачами
          content:
            text/calendar:
              schema:
                type: string
                format: binary
          headers:
            Content-Disposition:
              schema:
                type: string
                example: attachment; filename="tasks_2024-12-10.ics"
        "401": { $ref: "#/components/responses/Unauthorized" }
  /metrics/daily/{userId}:
    get:
      summary: Дневные метрики по задачам
      tags: [analytics]
      parameters:
        - in: path
          name: userId
          required: true
          schema: { type: integer, format: int64 }
        - in: query
          name: date
          schema:
            type: string
            format: date
            description: YYYY-MM-DD
      responses:
        "200":
          description: Метрики
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/DailyMetrics"
        "400": { $ref: "#/components/responses/BadRequest" }
